name: CI (PR minimal)

# Minimal checks on pull_request to reduce latency.
# Full test suites are moved to ci-full.yml and triggered after PR approval via workflow_run.
# Also runs on push to main for quick format/typo guardrails.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [created]

env:
  CARGO_TERM_COLOR: always

jobs:
  pre-commit-checks:
    name: Cargo fmt, typos
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v17
      - name: Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "nightly"
      - name: Cargo fmt
        run: |
          nix develop -i -L .#nightly --command bash -c '
            export RUSTFMT=$(command -v rustfmt)
            cargo fmt --check
          '
      - name: typos
        run: nix develop -i -L .#nightly --command typos

  clippy-pr-sample:
    name: Clippy (reduced set for PRs)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: pre-commit-checks
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        build-args:
          [
            -p cdk-common,
            -p cdk,
            -p cdk-axum,
            -p cdk-sqlite,
          ]
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v17
      - name: Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "stable"
      - name: Clippy (PR subset)
        run: nix develop -i -L .#stable --command cargo clippy ${{ matrix.build-args }} -- -D warnings

  doc-tests:
    name: Documentation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: pre-commit-checks
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v17
      - name: Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "stable"
      - name: Run doc tests
        run: nix develop -i -L .#stable --command cargo test --doc
